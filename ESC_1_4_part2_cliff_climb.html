<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ESC-1-4 Part 2ÔΩúÊÇ¨Â¥ñÊîÄÁôª Cliff ClimbÔºàËØç/Â≠ó/Âè•Â≠êÔºâv1.2</title>

  <style>
    :root{
      --bg1:#041021;
      --bg2:#00030a;
      --panel: rgba(255,255,255,.10);
      --border: rgba(255,255,255,.18);
      --text:#f4f7ff;
      --muted:#c3cffc;
      --accent:#ffd54a;
      --good:#63ffb0;
      --bad:#ff5f86;
      --shadow: 0 22px 70px rgba(0,0,0,.70);
      --radius: 18px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 18% 10%, rgba(120,110,255,.25), transparent 55%),
        radial-gradient(1200px 800px at 90% 35%, rgba(255,213,74,.18), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow:hidden;
      user-select:none;
      -webkit-user-select:none;
    }

    /* HUD */
    .hud{
      position:fixed;
      top:14px; left:14px; right:14px;
      display:flex; gap:12px;
      z-index:50;
      pointer-events:none;
    }
    .card{
      pointer-events:auto;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:12px 14px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .left{ flex:1 1 auto; }
    .right{ flex:0 0 auto; min-width: 290px; }

    .title{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
    }
    .title h1{
      margin:0;
      font-size:16px;
      color:var(--muted);
      font-weight:900;
      letter-spacing:.2px;
    }

    .modebar{
      margin-top:10px;
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .btn{
      cursor:pointer;
      border:none;
      border-radius:12px;
      padding:10px 12px;
      background:rgba(255,255,255,.12);
      color:var(--text);
      border:1px solid rgba(255,255,255,.18);
      font-weight:900;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .btn:hover{ background:rgba(255,255,255,.16); }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn.on{
      border-color: rgba(255,213,74,.70);
      box-shadow: 0 0 0 5px rgba(255,213,74,.12);
    }

    .prompt{
      margin-top:10px;
      display:grid;
      gap:8px;
    }
    .promptBig{
      font-size:30px;
      font-weight:1000;
      color:var(--accent);
      text-shadow: 0 10px 26px rgba(255,213,74,.28);
      line-height:1.05;
    }
    .hint{
      font-size:14px;
      color:var(--muted);
      line-height:1.3;
    }

    .progress{
      margin-top:8px;
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      font-size:18px;
    }
    .tok{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.24);
      color: rgba(255,255,255,.96);
      font-weight:1000;
    }
    .tok.done{
      border-color: rgba(99,255,176,.55);
      background: rgba(99,255,176,.14);
      color: rgba(99,255,176,.98);
    }
    .tok.now{
      border-color: rgba(255,213,74,.80);
      background: rgba(255,213,74,.18);
      color: rgba(255,213,74,.98);
      box-shadow: 0 0 0 5px rgba(255,213,74,.10);
    }

    .stats{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      color:var(--muted);
      font-size:14px;
      justify-content:flex-end;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      background:rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.14);
    }
    .pill b{ color:var(--text); font-weight:1000; }

    /* Scene background */
    #scene{
      position:fixed;
      inset:0;
      z-index:1;
      overflow:hidden;
    }
    .ocean{
      position:absolute; left:0; right:0; bottom:0;
      height:38vh;
      background:
        radial-gradient(900px 260px at 30% 20%, rgba(120,210,255,.30), transparent 60%),
        radial-gradient(900px 260px at 70% 40%, rgba(0,120,255,.22), transparent 60%),
        linear-gradient(180deg, rgba(0,30,70,.40), rgba(0,10,20,.96));
    }
    .ocean:before{
      content:"";
      position:absolute; inset:-40px 0 0 0;
      background: repeating-linear-gradient(90deg, rgba(255,255,255,.05) 0px, rgba(255,255,255,.05) 14px, rgba(0,0,0,0) 14px, rgba(0,0,0,0) 34px);
      opacity:.40;
      animation: waves 10s linear infinite;
    }
    @keyframes waves{ 0%{transform:translateX(0)} 100%{transform:translateX(-220px)} }

    .cliff{
      position:absolute;
      left:-6vw; top:0;
      width:58vw; height:100vh;
      background:
        radial-gradient(900px 800px at 40% 20%, rgba(255,255,255,.12), transparent 60%),
        linear-gradient(120deg, rgba(40,45,70,.95), rgba(12,14,22,.98));
      clip-path: polygon(0 0, 86% 0, 72% 32%, 90% 60%, 72% 100%, 0 100%);
      border-right: 1px solid rgba(255,255,255,.12);
      box-shadow: 20px 0 60px rgba(0,0,0,.55);
    }

    .sky{
      position:absolute; inset:0;
      background:
        radial-gradient(900px 600px at 70% 10%, rgba(255,213,74,.12), transparent 55%),
        radial-gradient(900px 600px at 90% 30%, rgba(130,110,255,.14), transparent 60%);
      pointer-events:none;
    }

    /* ‚úÖ Holds layer (È°∂Â±ÇÔºåÁªù‰∏çË¢´Áõñ‰Ωè) */
    #holdsLayer{
      position:fixed;
      inset:0;
      z-index:40;            /* ÊØîËÉåÊôØÈ´òÔºå‰Ωé‰∫é HUD(50) */
      pointer-events:auto;
    }

    .hold{
      position:absolute;
      width:170px;
      height:74px;
      transform: translate(-50%,-50%);
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.22);
      background:
        radial-gradient(110px 60px at 35% 30%, rgba(255,255,255,.18), transparent 60%),
        linear-gradient(145deg, rgba(255,255,255,.12), rgba(0,0,0,.22));
      box-shadow: 0 18px 40px rgba(0,0,0,.50);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
    }
    .hold:hover{
      transform: translate(-50%,-50%) scale(1.03);
      border-color: rgba(255,213,74,.70);
    }
    .hold:active{ transform: translate(-50%,-50%) scale(.99); }
    .hold .txt{
      font-size:34px;
      font-weight:1000;
      color:#fff;
      text-shadow: 0 12px 26px rgba(0,0,0,.55);
      letter-spacing: .5px;
    }
    .hold.bad{
      border-color: rgba(255,95,134,.85);
      box-shadow: 0 0 0 6px rgba(255,95,134,.14), 0 18px 40px rgba(0,0,0,.50);
      animation: wiggle .28s ease-in-out 2;
    }
    .hold.good{
      border-color: rgba(99,255,176,.70);
      box-shadow: 0 0 0 6px rgba(99,255,176,.12), 0 18px 40px rgba(0,0,0,.50);
    }
    @keyframes wiggle{
      0%{ transform: translate(-50%,-50%) rotate(0deg); }
      30%{ transform: translate(-50%,-50%) rotate(-4deg); }
      60%{ transform: translate(-50%,-50%) rotate(4deg); }
      100%{ transform: translate(-50%,-50%) rotate(0deg); }
    }

    /* Climber */
    .climber{
      position:fixed;
      left: 44vw;
      top: 68vh;
      width:62px; height:62px;
      border-radius: 18px;
      display:flex; align-items:center; justify-content:center;
      font-size:34px;
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 22px 55px rgba(0,0,0,.55);
      z-index:45; /* Âú®Â≠óÂç°‰∏äÈù¢‰∏ÄÁÇπÁÇπ‰πüË°å */
      transition: top .35s ease, left .35s ease;
      pointer-events:none;
    }
    .climber.fall{ animation: drop .42s ease-in; }
    @keyframes drop{
      0%{ transform: translateY(0) rotate(0deg); }
      100%{ transform: translateY(22px) rotate(8deg); }
    }

    /* ‚úÖ fallback choice bar (‰∏á‰∏ÄÂ≠óÂç°Ê≤°Âá∫Áé∞Ôºå‰πüËÉΩÁé©) */
    #fallbackBar{
      margin-top:8px;
      display:none;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .choice{
      cursor:pointer;
      border-radius:999px;
      padding:10px 14px;
      background:rgba(0,0,0,.30);
      border:1px solid rgba(255,255,255,.18);
      color:#fff;
      font-weight:1000;
    }
    .choice:hover{ border-color: rgba(255,213,74,.70); }

    /* Pause overlay */
    .overlay{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      z-index:80;
      background: rgba(0,0,0,.40);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .modal{
      width:min(900px, 92vw);
      padding:18px 18px 16px;
      border-radius:22px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      box-shadow: var(--shadow);
    }
    .modal h2{ margin:0 0 8px; font-size:20px; }
    .modal p{ margin:8px 0; color:var(--muted); line-height:1.45; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      padding:4px 8px;
      border-radius:10px;
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
    }

    @media (max-width: 780px){
      .hold{ width:152px; height:70px; }
      .hold .txt{ font-size:30px; }
      .promptBig{ font-size:26px; }
      .right{ min-width: 250px; }
      .climber{ left: 56vw; }
    }
  </style>
</head>

<body>
  <div class="hud">
    <div class="card left">
      <div class="title">
        <h1>ESC-1-4 Part 2ÔΩúÊÇ¨Â¥ñÊîÄÁôª Cliff ClimbÔºàËØç / Â≠ó / Âè•Â≠êÔºâv1.2</h1>
      </div>

      <div class="modebar">
        <button class="btn on" id="btnModeWord">ËØçËØ≠</button>
        <button class="btn" id="btnModeChar">ÂçïÂ≠ó</button>
        <button class="btn" id="btnModeSentence">Âè•Â≠êÈ°∫Â∫è</button>
        <span style="color:var(--muted);font-size:13px;">Á≠îÂØπ‰∏äÂçáÔºõÁ≠îÈîô‰∏ãÊªëÔºõ‰∏çËÆ°Êó∂</span>
      </div>

      <div class="prompt">
        <div class="promptBig" id="promptBig">z«éoshang</div>
        <div class="hint" id="hint">ÁÇπÂáªÊ≠£Á°ÆÁöÑËØçËØ≠„ÄÇ</div>

        <div class="progress" id="progress" style="display:none;"></div>

        <!-- ‚úÖ fallback choice bar -->
        <div id="fallbackBar"></div>
      </div>
    </div>

    <div class="card right">
      <div class="stats">
        <div class="pill">‚úÖ ÂàÜÊï∞ <b id="score">0</b></div>
        <div class="pill">‚ù§Ô∏è ÁîüÂëΩ <b id="lives">3</b></div>
        <button class="btn" id="btnPause">ÊöÇÂÅú</button>
        <button class="btn" id="btnReset">ÈáçÊù•</button>
      </div>
    </div>
  </div>

  <div id="scene">
    <div class="sky"></div>
    <div class="cliff"></div>
    <div class="ocean"></div>
  </div>

  <!-- ‚úÖ È°∂Â±ÇÂ≠óÂç°Â±Ç -->
  <div id="holdsLayer"></div>

  <!-- ‚úÖ ÊîÄÁôªËÄÖ -->
  <div class="climber" id="climber">üßó</div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <h2 id="ovTitle">Â∑≤ÊöÇÂÅú</h2>
      <p id="ovMsg">ÁÇπ‚ÄúÁªßÁª≠‚ÄùÂõûÂà∞Ê∏∏Êàè„ÄÇ</p>
      <div class="row">
        <span class="kbd">Á©∫Ê†º = ÊöÇÂÅú/ÁªßÁª≠</span>
        <span class="kbd">R = ÈáçÊù•</span>
        <span class="kbd">1/2/3 = ÂàáÊç¢Ê®°Âºè</span>
      </div>
      <div class="row">
        <button class="btn" id="btnGo">ÁªßÁª≠</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   DATA (ESC-1-4 Part 2)
   ========================= */
const WORDS = [
  {p:"z«éo", zh:"Êó©", en:"morning"},
  {p:"sh√†ng", zh:"‰∏ä", en:"suffix (Êó©‰∏ä/Êôö‰∏ä/‰∏äÂçà)"},
  {p:"z«éoshang", zh:"Êó©‰∏ä", en:"early morning"},
  {p:"w«î", zh:"Âçà", en:"noon"},
  {p:"sh√†ngw«î", zh:"‰∏äÂçà", en:"late morning"},
  {p:"zh≈çng", zh:"‰∏≠", en:"middle"},
  {p:"zh≈çngw«î", zh:"‰∏≠Âçà", en:"noon time"},
  {p:"xi√†", zh:"‰∏ã", en:"later / down"},
  {p:"xi√†w«î", zh:"‰∏ãÂçà", en:"afternoon"},
  {p:"w«én", zh:"Êôö", en:"evening"},
  {p:"w«énshang", zh:"Êôö‰∏ä", en:"evening / night"},
  {p:"ch√†", zh:"Â∑Æ", en:"fall short of (to)"},
];

const CHAR_ONLY = [
  {p:"z«éo", zh:"Êó©"},
  {p:"sh√†ng", zh:"‰∏ä"},
  {p:"w«î", zh:"Âçà"},
  {p:"zh≈çng", zh:"‰∏≠"},
  {p:"xi√†", zh:"‰∏ã"},
  {p:"w«én", zh:"Êôö"},
  {p:"ch√†", zh:"Â∑Æ"},
];

const SENTENCES = [
  { p:"xi√†n z√†i z«éoshang w«î di«én w«î sh√≠ fƒìn", zh:"Áé∞Âú®Êó©‰∏ä‰∫îÁÇπ‰∫îÂçÅÂàÜ„ÄÇ", tokens:["Áé∞","Âú®","Êó©","‰∏ä","‰∫î","ÁÇπ","‰∫î","ÂçÅ","ÂàÜ"] },
  { p:"xi√†n z√†i sh√†ngw«î sh√≠ di«én w«î sh√≠ fƒìn", zh:"Áé∞Âú®‰∏äÂçàÂçÅÁÇπ‰∫îÂçÅÂàÜ„ÄÇ", tokens:["Áé∞","Âú®","‰∏ä","Âçà","ÂçÅ","ÁÇπ","‰∫î","ÂçÅ","ÂàÜ"] },
  { p:"xi√†n z√†i zh≈çngw«î sh√≠ √®r di«én w«î sh√≠ fƒìn", zh:"Áé∞Âú®‰∏≠ÂçàÂçÅ‰∫åÁÇπ‰∫îÂçÅÂàÜ„ÄÇ", tokens:["Áé∞","Âú®","‰∏≠","Âçà","ÂçÅ","‰∫å","ÁÇπ","‰∫î","ÂçÅ","ÂàÜ"] },
  { p:"xi√†n z√†i xi√†w«î w«î di«én w«î sh√≠ fƒìn", zh:"Áé∞Âú®‰∏ãÂçà‰∫îÁÇπ‰∫îÂçÅÂàÜ„ÄÇ", tokens:["Áé∞","Âú®","‰∏ã","Âçà","‰∫î","ÁÇπ","‰∫î","ÂçÅ","ÂàÜ"] },
  { p:"xi√†n z√†i w«énshang li√π di«én w«î sh√≠ fƒìn", zh:"Áé∞Âú®Êôö‰∏äÂÖ≠ÁÇπ‰∫îÂçÅÂàÜ„ÄÇ", tokens:["Áé∞","Âú®","Êôö","‰∏ä","ÂÖ≠","ÁÇπ","‰∫î","ÂçÅ","ÂàÜ"] },
  { p:"xi√†n z√†i ch√† sh√≠ fƒìn bƒÅ di«én", zh:"Áé∞Âú®Â∑ÆÂçÅÂàÜÂÖ´ÁÇπ„ÄÇ", tokens:["Áé∞","Âú®","Â∑Æ","ÂçÅ","ÂàÜ","ÂÖ´","ÁÇπ"] },
];

const CHAR_POOL = [
  "Áé∞","Âú®","Êó©","‰∏ä","Âçà","‰∏≠","‰∏ã","Êôö","Â∑Æ",
  "ÁÇπ","ÂàÜ","ÂçÅ","‰∏Ä","‰∫å","‰∏â","Âõõ","‰∫î","ÂÖ≠","‰∏É","ÂÖ´","‰πù","Èõ∂"
];

/* =========================
   STATE
   ========================= */
const holdsLayer = document.getElementById("holdsLayer");
const climber = document.getElementById("climber");
const promptBig = document.getElementById("promptBig");
const hint = document.getElementById("hint");
const progress = document.getElementById("progress");
const fallbackBar = document.getElementById("fallbackBar");

const scoreEl = document.getElementById("score");
const livesEl = document.getElementById("lives");

const overlay = document.getElementById("overlay");
const ovTitle = document.getElementById("ovTitle");
const ovMsg = document.getElementById("ovMsg");
const btnGo = document.getElementById("btnGo");

const btnPause = document.getElementById("btnPause");
const btnReset = document.getElementById("btnReset");

const btnModeWord = document.getElementById("btnModeWord");
const btnModeChar = document.getElementById("btnModeChar");
const btnModeSentence = document.getElementById("btnModeSentence");

let running=false;
let paused=false;

let mode="word"; // word | char | sentence
let score=0;
let lives=3;

let target=null;
let sentence=null;
let sIndex=0;

let holds=[];   // [{el,isCorrect,text}]
let stage=0;
const STAGES=10;

/* =========================
   HELPERS
   ========================= */
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function shuffle(a){
  const b=[...a];
  for(let i=b.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [b[i],b[j]]=[b[j],b[i]];
  }
  return b;
}
function updateHUD(){ scoreEl.textContent=String(score); livesEl.textContent=String(lives); }
function showOverlay(title, message){
  ovTitle.textContent = title;
  ovMsg.textContent = message;
  overlay.style.display="flex";
}
function hideOverlay(){ overlay.style.display="none"; }

function removeHolds(){
  for(const h of holds){ h.el.remove(); }
  holds=[];
}

function flash(el, cls){
  el.classList.add(cls);
  setTimeout(()=>el.classList.remove(cls), 550);
}

/* =========================
   CLIMBER
   ========================= */
function placeClimber(){
  const t = stage / STAGES; // 0->1
  const topY = 18;
  const bottomY = 76;
  const y = bottomY - (bottomY-topY)*t;
  const x = 44 - 8*Math.sin(t*Math.PI);
  climber.style.top = y + "vh";
  climber.style.left = x + "vw";
}
function climbUp(){
  stage = Math.min(STAGES, stage+1);
  placeClimber();
  if(stage >= STAGES){
    running=false;
    showOverlay("ÈÄöÂÖ≥ÔºÅ", "‰Ω†Áà¨Âà∞È°∂‰∫ÜÔºÅÁÇπ‚ÄúÁªßÁª≠‚Äù‰ºöËá™Âä®ÈáçÂºÄ„ÄÇ");
  }
}
function slipDown(){
  stage = Math.max(0, stage-1);
  climber.classList.add("fall");
  setTimeout(()=>climber.classList.remove("fall"), 450);
  placeClimber();

  if(stage===0){
    lives -= 1;
    updateHUD();
    if(lives<=0){
      running=false;
      showOverlay("ÊéâËøõÊµ∑Èáå‰∫Ü‚Ä¶", "Ê∏∏ÊàèÁªìÊùü„ÄÇÁÇπ‚ÄúÁªßÁª≠‚ÄùÈáçÂºÄ„ÄÇ");
    }
  }
}

/* =========================
   HOLDS (ÂÖ≥ÈîÆÔºöÂõ∫ÂÆöÂà∞È°∂Â±Ç holdsLayer)
   ========================= */
function createHold(xVW, yVH, text, isCorrect){
  const el=document.createElement("div");
  el.className="hold";
  el.style.left = xVW + "vw";
  el.style.top = yVH + "vh";
  el.innerHTML = `<div class="txt">${text}</div>`;

  el.addEventListener("pointerdown",(e)=>{
    e.preventDefault();
    if(!running || paused) return;
    onChoose(el, isCorrect, text);
  },{passive:false});

  holdsLayer.appendChild(el);
  holds.push({el, isCorrect, text});
}

/* =========================
   FALLBACK BAR
   ========================= */
function setFallbackChoices(choices, correctText){
  fallbackBar.innerHTML="";
  fallbackBar.style.display="flex";
  choices.forEach(t=>{
    const b=document.createElement("button");
    b.className="choice";
    b.textContent=t;
    b.onclick=()=>{
      if(!running || paused) return;
      onChoose(b, t===correctText, t);
    };
    fallbackBar.appendChild(b);
  });
}
function hideFallback(){ fallbackBar.style.display="none"; fallbackBar.innerHTML=""; }

/* =========================
   SENTENCE PROGRESS
   ========================= */
function renderSentenceProgress(){
  progress.innerHTML="";
  sentence.tokens.forEach((t,i)=>{
    const s=document.createElement("span");
    s.className="tok";
    s.textContent=t;
    if(i<sIndex) s.classList.add("done");
    if(i===sIndex) s.classList.add("now");
    progress.appendChild(s);
  });
}

/* =========================
   ROUND BUILDERS
   ========================= */
function buildHoldsWordOrChar(correctZh){
  removeHolds();
  hideFallback();

  const ys = [66, 54, 42, 30];
  const xs = [28, 36, 24, 34];

  const pool = (mode==="word") ? WORDS.map(x=>x.zh) : CHAR_ONLY.map(x=>x.zh);
  const distract = shuffle(pool.filter(z=>z!==correctZh)).slice(0,3);
  const choices = shuffle([correctZh, ...distr]);

  for(let i=0;i<4;i++){
    createHold(xs[i], ys[i], choices[i], choices[i]===correctZh);
  }

  // Â§á‰ªΩÊù°ÔºöÂ¶ÇÊûúÂ≠óÂç°Â±ÇÂºÇÂ∏∏Ôºå‰ªçËÉΩÁÇπ
  setTimeout(()=>{
    if(holds.length===0){
      setFallbackChoices(choices, correctZh);
    }
  }, 60);
}

function buildHoldsSentence(needChar){
  removeHolds();
  hideFallback();

  const ys = [66, 56, 46, 36, 26];
  const xs = [26, 36, 22, 34, 28];

  const distract = shuffle(CHAR_POOL.filter(c=>c!==needChar)).slice(0,4);
  const choices = shuffle([needChar, ...distr]);

  for(let i=0;i<5;i++){
    createHold(xs[i], ys[i], choices[i], choices[i]===needChar);
  }

  setTimeout(()=>{
    if(holds.length===0){
      setFallbackChoices(choices, needChar);
    }
  }, 60);
}

function nextWordTarget(){
  target = pick(WORDS);
  promptBig.textContent = target.p;
  hint.textContent = "ÁÇπÂáªÊ≠£Á°ÆÁöÑËØçËØ≠„ÄÇ";
  progress.style.display="none";
  buildHoldsWordOrChar(target.zh);
}

function nextCharTarget(){
  target = pick(CHAR_ONLY);
  promptBig.textContent = target.p;
  hint.textContent = "ÁÇπÂáªÊ≠£Á°ÆÁöÑÂçïÂ≠ó„ÄÇ";
  progress.style.display="none";
  buildHoldsWordOrChar(target.zh);
}

function nextSentence(){
  sentence = pick(SENTENCES);
  sIndex = 0;
  promptBig.textContent = sentence.p;
  hint.textContent = "ÊåâÈ°∫Â∫èÁÇπÂáªÂè•Â≠êÈáåÁöÑ‰∏ã‰∏Ä‰∏™Â≠ó„ÄÇ";
  progress.style.display="flex";
  renderSentenceProgress();
  buildHoldsSentence(sentence.tokens[sIndex]);
}

function newRound(){
  if(mode==="word") nextWordTarget();
  else if(mode==="char") nextCharTarget();
  else nextSentence();
}

/* =========================
   ANSWER HANDLER
   ========================= */
function onChoose(el, isCorrect, text){
  // el ÂèØËÉΩÊòØ hold divÔºå‰πüÂèØËÉΩÊòØ fallback button
  if(isCorrect){
    // Âè™ÊúâÁúüÊ≠£ hold ÊâçÊúâ classList good/bad
    if(el.classList) flash(el, "good");
    score += 1;
    updateHUD();
    climbUp();

    if(mode==="sentence"){
      sIndex += 1;
      if(sIndex >= sentence.tokens.length){
        score += 2;
        updateHUD();
        nextSentence();
      }else{
        renderSentenceProgress();
        buildHoldsSentence(sentence.tokens[sIndex]);
      }
    }else{
      newRound();
    }
  }else{
    if(el.classList) flash(el, "bad");
    slipDown();
  }
}

/* =========================
   MODE + CONTROLS
   ========================= */
function setMode(m){
  mode=m;
  btnModeWord.classList.toggle("on", mode==="word");
  btnModeChar.classList.toggle("on", mode==="char");
  btnModeSentence.classList.toggle("on", mode==="sentence");
  newRound();
}

function resetGame(){
  running=true;
  paused=false;
  score=0;
  lives=3;
  stage=0;
  sIndex=0;
  updateHUD();
  placeClimber();
  hideOverlay();
  newRound();
}

function togglePause(){
  if(!running) return;
  paused = !paused;
  btnPause.textContent = paused ? "ÁªßÁª≠" : "ÊöÇÂÅú";
  if(paused){
    showOverlay("Â∑≤ÊöÇÂÅú", "ÁÇπ‚ÄúÁªßÁª≠‚ÄùÂõûÂà∞Ê∏∏Êàè„ÄÇ");
  }else{
    hideOverlay();
  }
}

/* Buttons */
btnGo.addEventListener("click",()=>{
  if(!running || lives<=0 || stage>=STAGES){
    resetGame();
    return;
  }
  paused=false;
  hideOverlay();
  btnPause.textContent="ÊöÇÂÅú";
});

btnPause.addEventListener("click",()=> togglePause());
btnReset.addEventListener("click",()=> resetGame());

btnModeWord.addEventListener("click",()=>{ setMode("word"); });
btnModeChar.addEventListener("click",()=>{ setMode("char"); });
btnModeSentence.addEventListener("click",()=>{ setMode("sentence"); });

window.addEventListener("keydown",(e)=>{
  if(e.code==="Space"){ e.preventDefault(); togglePause(); }
  if(e.key.toLowerCase()==="r"){ e.preventDefault(); resetGame(); }
  if(e.key==="1"){ setMode("word"); }
  if(e.key==="2"){ setMode("char"); }
  if(e.key==="3"){ setMode("sentence"); }
});

/* =========================
   INIT (Ëá™Âä®ÂºÄÂßã)
   ========================= */
placeClimber();
updateHUD();

running = true;
paused = false;

// ÈªòËÆ§Ê®°ÂºèÔºö‰Ω†ÊÉ≥ÈªòËÆ§ËØçËØ≠Â∞±ÊîπÊàê "word"
setMode("sentence");

// ÂÜçË°•‰∏§Ê¨°Á°Æ‰øùÁîüÊàêÔºà‰∏çÂêåÊµèËßàÂô®Ê∏≤ÊüìËäÇÂ•è‰∏çÂêåÔºâ
setTimeout(()=>{ if(holds.length===0) newRound(); }, 120);
setTimeout(()=>{ if(holds.length===0) newRound(); }, 450);
</script>
</body>
</html>
